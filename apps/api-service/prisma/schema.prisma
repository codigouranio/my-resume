// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  // extensions = [pgvector(map: "vector")] // Temporarily disabled - requires superuser
}

enum Role {
  USER
  ADMIN
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

enum ChatSentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
  UNKNOWN
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  role      Role     @default(USER)
  
  // Subscription
  subscriptionTier       SubscriptionTier @default(FREE)
  subscriptionEndsAt     DateTime?
  stripeCustomerId       String?          @unique
  stripeSubscriptionId   String?          @unique
  
  // Custom subdomain (PRO feature)
  customDomain           String?          @unique
  defaultResumeId        String?          // Resume to show at custom subdomain root
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  resumes       Resume[]
  refreshTokens RefreshToken[]
  defaultResume Resume?  @relation("DefaultResume", fields: [defaultResumeId], references: [id])
  
  @@index([email])
  @@index([stripeCustomerId])
  @@index([customDomain])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
}

model Resume {
  id          String   @id @default(cuid())
  userId      String
  slug        String   @unique // For custom URLs: /resume/{slug}
  title       String
  content     String   @db.Text // Markdown content (public view)
  llmContext  String?  @db.Text // Hidden details for LLAMA context (not shown publicly)
  isPublic    Boolean  @default(false)
  isPublished Boolean  @default(false)
  
  // Customization
  templateId  String?
  theme       String?  @default("default")
  customCss   String?  @db.Text
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  // Analytics
  viewCount Int @default(0)
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  template          Template?           @relation(fields: [templateId], references: [id])
  recruiterInterests RecruiterInterest[]
  views             ResumeView[]
  defaultForUsers   User[]              @relation("DefaultResume")
  // embeddings        ResumeEmbedding?  // Temporarily disabled - pgvector not available
  chatInteractions  ChatInteraction[]
  chatAnalytics     ChatAnalytics[]
  
  @@index([userId])
  @@index([slug])
  @@index([isPublic, isPublished])
}

model Template {
  id          String   @id @default(cuid())
  name        String
  description String?
  preview     String?  // Preview image URL
  content     String   @db.Text // Template structure/layout
  isPremium   Boolean  @default(false)
  isActive    Boolean  @default(true)
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  resumes Resume[]
  
  @@index([isActive, isPremium])
}

model RecruiterInterest {
  id         String    @id @default(cuid())
  resumeId   String
  name       String
  email      String
  company    String?
  message    String    @db.Text
  isRead     Boolean   @default(false)
  isFavorite Boolean   @default(false)
  deletedAt  DateTime?
  
  // Metadata
  createdAt DateTime @default(now())
  
  // Relations
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  @@index([resumeId])
  @@index([createdAt])
  @@index([isRead])
  @@index([isFavorite])
  @@index([deletedAt])
}

model ResumeView {
  id        String   @id @default(cuid())
  resumeId  String
  
  // Visitor information
  ipAddress    String?
  userAgent    String?  @db.Text
  country      String?
  city         String?
  referrer     String?  @db.Text
  
  // Session tracking
  sessionId    String?
  duration     Int?     // Time spent on page in seconds
  
  // Metadata
  viewedAt     DateTime @default(now())
  
  // Relations
  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  @@index([resumeId])
  @@index([viewedAt])
  @@index([sessionId])
  @@index([country])
}

// model ResumeEmbedding {
//   id                    String                       @id @default(cuid())
//   resumeId              String                       @unique
//   
//   // Embeddings (nomic-embed-text produces 768-dimensional vectors)
//   contentEmbedding      Unsupported("vector(768)")?  // Public resume content
//   llmContextEmbedding   Unsupported("vector(768)")?  // Hidden AI context
//   combinedEmbedding     Unsupported("vector(768)")?  // Weighted combination for search
//   
//   // Metadata for tracking
//   embeddingModel        String                       @default("nomic-embed-text")
//   contentHash           String?                      // MD5 hash to detect changes
//   llmContextHash        String?
//   
//   // Timestamps
//   createdAt             DateTime                     @default(now())
//   updatedAt             DateTime                     @updatedAt
//   
//   // Relations
//   resume                Resume                       @relation(fields: [resumeId], references: [id], onDelete: Cascade)
//   
//   @@index([resumeId])
// }

model ChatInteraction {
  id               String         @id @default(cuid())
  resumeId         String
  sessionId        String?
  
  // Q&A content
  question         String         @db.Text
  answer           String         @db.Text
  
  // Analysis
  sentiment        ChatSentiment? @default(UNKNOWN)
  wasAnsweredWell  Boolean?       @default(true)
  topics           String[]       // Extracted topics/keywords
  
  // Visitor information
  ipAddress        String?
  userAgent        String?        @db.Text
  country          String?
  referrer         String?        @db.Text
  
  // Performance
  responseTime     Int?           // Response time in milliseconds
  
  // Metadata
  createdAt        DateTime       @default(now())
  
  // Relations
  resume           Resume         @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  @@index([resumeId])
  @@index([sessionId])
  @@index([createdAt])
  @@index([sentiment])
  @@index([wasAnsweredWell])
}

model ChatTopic {
  id              String   @id @default(cuid())
  name            String   @unique
  category        String   // e.g., "skills", "experience", "education", "projects"
  keywords        String[] // Keywords to match
  questionCount   Int      @default(0)
  negativeCount   Int      @default(0) // Questions that weren't answered well
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([category])
  @@index([questionCount])
}

model ChatAnalytics {
  id              String    @id @default(cuid())
  resumeId        String
  date            DateTime  @db.Date
  
  // Aggregated metrics
  totalQuestions  Int       @default(0)
  uniqueSessions  Int       @default(0)
  avgResponseTime Float?
  
  // Sentiment breakdown
  positiveCount   Int       @default(0)
  neutralCount    Int       @default(0)
  negativeCount   Int       @default(0)
  
  // Topic analysis
  topTopics       Json?     // Array of {topic: string, count: number, negativeCount: number}
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  resume          Resume    @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  @@unique([resumeId, date])
  @@index([resumeId])
  @@index([date])
}
