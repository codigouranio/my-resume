---
# Quick update playbook - Only updates code and restarts services
- name: Update My Resume Application
  hosts: production
  become: yes
  
  tasks:
    - name: Pull latest code
      git:
        repo: https://github.com/codigouranio/my-resume.git
        dest: "{{ app_root }}"
        version: main
        force: yes
      become_user: "{{ ansible_user }}"
    
    - name: Install/Update API dependencies
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        npm install
      args:
        chdir: "{{ api_service_path }}"
        executable: /bin/bash
      become_user: "{{ ansible_user }}"
    
    - name: Install/Update GraphQL and CQRS dependencies
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        npm install @nestjs/graphql @nestjs/apollo @nestjs/cqrs @apollo/server graphql
      args:
        chdir: "{{ api_service_path }}"
        executable: /bin/bash
      become_user: "{{ ansible_user }}"
    
    - name: Apply Prisma migrations (production safe)
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        export DATABASE_URL="postgresql://{{ postgres_user }}:{{ postgres_password }}@localhost:5432/{{ postgres_db }}?schema=public"
        npx prisma migrate deploy
      args:
        chdir: "{{ api_service_path }}"
        executable: /bin/bash
      become_user: "{{ ansible_user }}"
      register: migration_result
      failed_when: false
    
    - name: Fallback to db push if no migrations found
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        export DATABASE_URL="postgresql://{{ postgres_user }}:{{ postgres_password }}@localhost:5432/{{ postgres_db }}?schema=public"
        npx prisma db push --accept-data-loss
      args:
        chdir: "{{ api_service_path }}"
        executable: /bin/bash
      become_user: "{{ ansible_user }}"
      when: migration_result.rc != 0 or 'No migration found' in migration_result.stderr
    
    - name: Generate Prisma Client
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        export DATABASE_URL="postgresql://{{ postgres_user }}:{{ postgres_password }}@localhost:5432/{{ postgres_db }}?schema=public"
        npx prisma generate
      args:
        chdir: "{{ api_service_path }}"
        executable: /bin/bash
      become_user: "{{ ansible_user }}"
    
    - name: Rebuild API Service
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        npm run build
      args:
        chdir: "{{ api_service_path }}"
        executable: /bin/bash
      become_user: "{{ ansible_user }}"
    
    - name: Update LLM conda environment dependencies
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        conda install -y -c conda-forge flask flask-cors requests python-dotenv psycopg2-binary
      args:
        executable: /bin/bash
      become_user: "{{ ansible_user }}"
      ignore_errors: yes
    
    - name: Configure LLM Service environment
      copy:
        dest: "{{ llm_service_path }}/.env"
        content: |
          PORT={{ llm_port }}
          LLAMA_SERVER_URL={{ llama_server_url }}
          LLAMA_API_TYPE=ollama
          OLLAMA_MODEL={{ ollama_model }}
          RESUME_PATH=../../data/resume.md
          DATABASE_URL=postgresql://{{ postgres_user }}:{{ postgres_password }}@localhost:5432/{{ postgres_db }}
          ADMIN_TOKEN={{ llm_admin_token }}
          API_BASE_URL=http://localhost:{{ api_port }}/api
          RESUME_SLUG=jose-blanco-swe
        owner: "{{ ansible_user }}"
        mode: '0600'
    
    - name: Configure Frontend environment
      copy:
        dest: "{{ frontend_path }}/.env"
        content: |
          PUBLIC_API_URL=/api
          PUBLIC_LLM_API_URL=/llm
        owner: "{{ ansible_user }}"
        mode: '0644'
    
    - name: Install/Update Frontend dependencies
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ frontend_path }}/conda-env
        rm -rf node_modules package-lock.json
        npm install
      args:
        chdir: "{{ frontend_path }}"
        executable: /bin/bash
      become_user: "{{ ansible_user }}"
    
    - name: Rebuild Frontend
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ frontend_path }}/conda-env
        npm run build
      args:
        chdir: "{{ frontend_path }}"
        executable: /bin/bash
      become_user: "{{ ansible_user }}"
    
    - name: Reload PM2 services
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        which pm2 || npm install -g pm2
        $(npm root -g)/pm2/bin/pm2 reload all
      args:
        executable: /bin/bash
      become_user: "{{ ansible_user }}"
    
    - name: Verify RecruiterInterest table exists
      shell: |
        PGPASSWORD='{{ postgres_password }}' psql -h localhost -U {{ postgres_user }} -d {{ postgres_db }} -c "\d \"RecruiterInterest\"" 2>&1 | grep -q 'Table'
      register: recruiter_table_check
      failed_when: false
      changed_when: false
    
    - name: Display update info
      debug:
        msg: 
          - "✅ Application updated and restarted successfully!"
          - "✅ RecruiterInterest table: {{ 'Exists' if recruiter_table_check.rc == 0 else 'Missing - may need manual migration' }}"
