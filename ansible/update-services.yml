---
# Update services with latest code changes (no downtime)
# Usage: ansible-playbook update-services.yml --ask-vault-pass --ask-become-pass

- name: "ðŸ”„ Update Services with Latest Changes"
  hosts: all
  become: yes
  become_user: "{{ ansible_user }}"
  
  tasks:
    - name: Pull latest code from git
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_root }}"
        version: "{{ repo_branch }}"
        force: yes
      register: git_result

    - name: Display git changes
      debug:
        msg: "Git updated: {{ git_result.changed }}"

    # API Service
    - name: Install API dependencies
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        npm install
      args:
        chdir: "{{ api_service_path }}"
        executable: /bin/bash
      when: git_result.changed

    - name: Generate Prisma Client
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        npx prisma generate
      args:
        chdir: "{{ api_service_path }}"
        executable: /bin/bash
      when: git_result.changed

    - name: Build API Service
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ api_service_path }}/conda-env
        npm run build
      args:
        chdir: "{{ api_service_path }}"
        executable: /bin/bash
      when: git_result.changed

    - name: Restart API Service
      command: "/home/{{ ansible_user }}/.npm-global/bin/pm2 restart api-service"
      when: git_result.changed

    # LLM Service (no build needed, Python)
    - name: Restart LLM Service
      command: "/home/{{ ansible_user }}/.npm-global/bin/pm2 restart llm-service"
      when: git_result.changed

    # Frontend
    - name: Clean frontend node_modules and lock file
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ frontend_path }}/node_modules"
        - "{{ frontend_path }}/package-lock.json"
      when: git_result.changed

    - name: Install frontend dependencies
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ frontend_path }}/conda-env
        npm install
      args:
        chdir: "{{ frontend_path }}"
        executable: /bin/bash
      when: git_result.changed

    - name: Build frontend
      shell: |
        source /opt/miniconda3/etc/profile.d/conda.sh
        conda activate {{ frontend_path }}/conda-env
        npm run build
      args:
        chdir: "{{ frontend_path }}"
        executable: /bin/bash
      when: git_result.changed

    - name: Display completion message
      debug:
        msg: |
          âœ… Services updated successfully!
          
          Check status: pm2 status
          View logs: pm2 logs
